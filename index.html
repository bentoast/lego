<!doctype html>
<html>
<head>

<title>Lego Tracker</title>
<link rel="stylesheet" href="styles/main.css" />
<script src="scripts/main.js" type="text/javascript"></script>
<script src="scripts/legoset.js" type="text/javascript"></script>
<script>
var showClass = " noshow";
var sets = [];
var columns = ["setid", "name", "price", "originalprice", "discount", "retiring", "new"];

function GetRequest(url, data, callback) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200)
    {
      var j = JSON.parse(this.responseText);
      callback(j);
    }
  }

  if (data)
  {
    xhttp.open("POST", url, true);
    xhttp.send(data);
  }
  else
  {
    xhttp.open("GET", url, true);
    xhttp.send();
  }
}

function CreateTable(url, table) {
  GetRequest(url, null, function(results) {  
    var i = 0;
    for (var e in results)
    {
      var n = new LegoSet(results[e]);
      n.CreateRow();
      sets.push(n);
    }
    
    sortby('name');
  });
}

function filterTable() {
  var telem = document.getElementById('settable');
  
  for (var i in sets)
  {
    sets[i].Element.remove();
  }
  
  var filteredSet = sets;
  
  var currentFilter = document.getElementById('havefilter');
  if (currentFilter['checked'])
    filteredSet = filteredSet.filter(f => f['have']);
  currentFilter = document.getElementById('trackedfilter');
  if (currentFilter['checked'])
    filteredSet = filteredSet.filter(f => f['tracked']);
  currentFilter = document.getElementById('setidfilter');
  if (currentFilter['value'])
    filteredSet = filteredSet.filter(f => f['setid'].toLowerCase().includes(currentFilter['value'].toLowerCase()));
  currentFilter = document.getElementById('namefilter');
  if (currentFilter['value'])
    filteredSet = filteredSet.filter(f => f['name'].toLowerCase().includes(currentFilter['value'].toLowerCase()));
  currentFilter = document.getElementById('pricefilter');
  if (currentFilter['value'])
    filteredSet = filteredSet.filter(f => f['price'] <= currentFilter['value']);
  currentFilter = document.getElementById('originalfilter');
  if (currentFilter['value'])
    filteredSet = filteredSet.filter(f => f['originalprice'] <= currentFilter['value']);
  currentFilter = document.getElementById('discountfilter');
  if (currentFilter['value'])
    filteredSet = filteredSet.filter(f => f['discount'] >= (currentFilter['value'] / 100));
  currentFilter = document.getElementById('retiringfilter');
  if (currentFilter['checked'])
    filteredSet = filteredSet.filter(f => f['retiring']);
  currentFilter = document.getElementById('newfilter');
  if (currentFilter['checked'])
    filteredSet = filteredSet.filter(f => f['new']);
  
  for (var i in filteredSet)
  {
    var n = filteredSet[i];
    if (i % 2 == 0)
      n.Element.className = "itemrow";
    else
      n.Element.className = "itemrow striped";
    telem.appendChild(n.Element);
  }
}

var sortAttribute = '';
function sortby(attribute) {
  if (sortAttribute != attribute)
  {
    sortAttribute = attribute;
    sets.sort(function(a, b) {
      if (a[attribute] < b[attribute])
        return -1;
      if (a[attribute] > b[attribute])
        return 1;
      return 0;
    });
  }
  else
  {
    sortAttribute = '';
    sets.sort(function(b, a) {
      if (a[attribute] < b[attribute])
        return -1;
      if (a[attribute] > b[attribute])
        return 1;
      return 0;
    });
  }
  filterTable();
}

function findset(source) {
  GetRequest('lego.py?action=check&setid=' + source['value'], null, addToList);
}

function addToList(results) {
  if (results.length > 0)
  {
    var r = results[0];
    var found = sets.filter(f => f['setid'] == r['setid']);
    if (found.length == 0)
    {
      var curSet = new LegoSet(r);
      curSet.CreateRow();
      sets.push(curSet);
      filterTable();
    }
  }
}

function init() {
  CreateTable("lego.py?count=25&page=1", "settable");
}
</script>
</head>
<body onload="init();">
<table id="settable">
  <tr class="titlerow">
    <td colspan="2">Sets</td>
    <td colspan="7">Find Set: <input type="text" onchange="findset(this);" /></td>
  </tr>
  <tr>
    <td style="text-align: center;"><input type="checkbox" id="havefilter" onchange="filterTable();" /></td>
    <td style="text-align: center;"><input type="checkbox" id="trackedfilter" onchange="filterTable();" /></td>
    <td><input type="text" style="width: 50px;" id="setidfilter" onchange="filterTable();" /></td>
    <td><input type="text" style="width: 100%" id="namefilter" onchange="filterTable();" /></td>
    <td><input type="text" style="text-align: right; width: 85px;" id="pricefilter" onchange="filterTable();" /></td>
    <td><input type="text" style="text-align: right; width: 85px;" id="originalfilter" onchange="filterTable();" /></td>
    <td><input type="text" style="text-align: right; width: 55px;" id="discountfilter" onchange="filterTable();" /></td>
    <td style="text-align: center;"><input type="checkbox" id="retiringfilter" onchange="filterTable();" /></td>
    <td style="text-align: center;"><input type="checkbox" id="newfilter" onchange="filterTable();" /></td>
  </tr>
  <tr class="headerrow">
    <td>Have</td>
    <td>Track</td>
    <td onclick="sortby('setid');">Set Id</td>
    <td onclick="sortby('name');">Name</td>
    <td onclick="sortby('price');">Current Price</td>
    <td onclick="sortby('originalprice');">Original Price</td>
    <td onclick="sortby('discount');">Discount</td>
    <td onclick="sortby('retiring');">Retiring</td>
    <td onclick="sortby('new');">New</td>
  </tr>
</table>
</body>
</html>
